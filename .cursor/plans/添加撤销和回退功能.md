<!-- 2b5b32ca-f061-45c9-a6b3-bc91cf01e036 d1bbd362-dc4d-4968-8e09-f04933655308 -->
# 添加撤销和回退功能

## 功能需求

1. **撤销（完全撤销）**：重置到最初加载的原始图片，清除所有编辑操作
2. **回退（上一次应用的状态）**：撤销最后一次应用的操作（如应用裁剪、应用旋转、添加文本等）

## 实现方案

### 1. 在 Controller 中添加历史状态管理

**位置**：`lib/controller/image_editor_controller.dart`

- 保存原始图片：在构造函数中保存初始图片的副本
- 保存历史状态：在每次应用操作前，保存当前状态的快照（图片、文本图层、变换参数等）
- 实现撤销方法：`resetToOriginal()` - 重置到原始图片和初始状态
- 实现回退方法：`undoLastOperation()` - 回退到上一次应用操作前的状态

### 2. 状态快照数据结构

需要保存的状态包括：

- 当前图片 (`ui.Image`)
- 文本图层列表 (`List<TextLayerData>`)
- 旋转角度 (`double`)
- 缩放比例 (`double`)

### 3. 在工具栏UI中添加按钮

**位置**：`lib/widgets/toolbars/main_toolbar.dart`

- 在主工具栏中添加撤销和回退按钮
- 按钮应该根据是否有可撤销/回退的状态来启用/禁用
- 按钮图标：撤销使用 `Icons.refresh`，回退使用 `Icons.undo`

### 4. 集成到应用操作流程

- 在 `applyCurrentTool()` 方法中，在应用操作前保存当前状态
- 确保文本图层的添加、删除等操作也能被回退

## 实现细节

1. **原始图片保存**：在构造函数中深拷贝原始图片（或保存引用，因为 `ui.Image` 是不可变的）
2. **历史状态管理**：使用一个状态快照列表，每次应用操作前保存，回退时恢复
3. **状态检查**：提供方法检查是否可以撤销/回退，用于控制按钮的启用状态
4. **内存管理**：注意 `ui.Image` 的内存占用，考虑限制历史记录数量

### To-dos

- [ ] 修复 _captureTransformedImage() 方法，使用原图像素尺寸而非屏幕尺寸进行导出
- [ ] 实现计算变换后图片实际像素尺寸的逻辑（考虑旋转和缩放）
- [ ] 添加 FilterQuality.high 保持高清晰度
- [ ] 修复文本图层坐标转换，确保在导出图片中位置正确
- [ ] 验证裁剪后图片尺寸计算是否正确
- [ ] 在 Controller 中添加原始图片保存和历史状态管理（状态快照）
- [ ] 实现 resetToOriginal() 方法，重置到原始图片和初始状态
- [ ] 实现 undoLastOperation() 方法，回退到上一次应用操作前的状态
- [ ] 在 applyCurrentTool() 中集成状态快照保存逻辑
- [ ] 在 MainToolbar 中添加撤销和回退按钮，并实现启用/禁用逻辑